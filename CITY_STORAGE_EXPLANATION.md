# Как работает сохранение города в localStorage

## Механизм работы

### 1. Первый визит с меткой города

**Сценарий:** Пользователь переходит по ссылке из Яндекс Директ:
```
https://ваш-сайт.ru/index.html?city=saratov
```

**Что происходит:**
1. JavaScript определяет город `saratov` из параметра `?city=saratov`
2. Город **сохраняется в localStorage** браузера
3. Все номера телефонов заменяются на номера для Саратова: `+7 (958) 563-51-81`
4. Все ссылки на странице получают параметр `?city=saratov`

### 2. Переход на другие страницы

**Сценарий:** Пользователь кликает на ссылку "Ремонт стиральных машин"

**Что происходит:**
1. Ссылка автоматически получает параметр: `remont-stiralnoj-mashiny.html?city=saratov`
2. При переходе город снова определяется из URL
3. Город **обновляется в localStorage** (на всякий случай)
4. Номера телефонов остаются для Саратова
5. Все ссылки продолжают иметь `?city=saratov`

### 3. Переход на страницу БЕЗ метки города

**Сценарий:** Пользователь вручную вводит в адресной строке:
```
https://ваш-сайт.ru/remont-holodilnika.html
```
(без параметра `?city=`)

**Что происходит:**
1. JavaScript не находит город в URL
2. Проверяет **localStorage** - находит сохраненный город `saratov`
3. Использует сохраненный город из localStorage
4. Все номера телефонов показываются для Саратова: `+7 (958) 563-51-81`
5. Все ссылки автоматически получают параметр `?city=saratov`

### 4. Смена города

**Сценарий:** Пользователь переходит по ссылке для другого города:
```
https://ваш-сайт.ru/index.html?city=ulyanovsk
```

**Что происходит:**
1. JavaScript определяет новый город `ulyanovsk` из URL
2. Город **обновляется в localStorage** (старый `saratov` заменяется на `ulyanovsk`)
3. Все номера телефонов заменяются на номера для Ульяновска: `+7 (984) 500-48-30`
4. Все ссылки получают параметр `?city=ulyanovsk`
5. При дальнейших переходах используется Ульяновск

## Приоритет определения города

Система проверяет город в следующем порядке:

1. **Query-параметр в URL** (`?city=saratov`) - самый высокий приоритет
2. **Префикс в пути** (`/saratov/index.html`) - если используется режим `path`
3. **localStorage** - сохраненный город из предыдущих визитов
4. **Город по умолчанию** (`default`) - если ничего не найдено

## Примеры работы

### Пример 1: Полный цикл использования

```
1. Пользователь переходит: index.html?city=saratov
   → Город сохранен: saratov
   → Номера: +7 (958) 563-51-81

2. Кликает на "Стиральные машины"
   → Переход: remont-stiralnoj-mashiny.html?city=saratov
   → Город сохранен: saratov
   → Номера: +7 (958) 563-51-81

3. Кликает на "Холодильники"
   → Переход: remont-holodilnika.html?city=saratov
   → Город сохранен: saratov
   → Номера: +7 (958) 563-51-81

4. Пользователь закрывает браузер и возвращается через день
   → Переход: index.html (без параметра)
   → localStorage содержит: saratov
   → Номера: +7 (958) 563-51-81 (для Саратова!)
   → Все ссылки получают: ?city=saratov
```

### Пример 2: Смена города

```
1. Пользователь переходит: index.html?city=saratov
   → Номера: +7 (958) 563-51-81

2. Переходит по ссылке для Ульяновска: index.html?city=ulyanovsk
   → Город обновлен в localStorage: ulyanovsk
   → Номера: +7 (984) 500-48-30

3. Все дальнейшие переходы используют Ульяновск
```

## Важные особенности

### ✅ Что работает автоматически:

- Сохранение города при первом визите
- Использование сохраненного города на страницах без метки
- Автоматическое добавление метки ко всем ссылкам
- Обновление города при переходе на другой город

### ⚠️ Важные моменты:

1. **localStorage привязан к домену** - если пользователь зайдет с другого домена, город не сохранится

2. **Очистка браузера** - если пользователь очистит данные браузера, localStorage будет очищен

3. **Приватный режим** - в приватном режиме localStorage может работать по-другому

4. **Срок хранения** - localStorage хранится до тех пор, пока пользователь не очистит данные браузера

## Тестирование

### Проверка сохранения города:

1. Откройте консоль браузера (F12)
2. Перейдите на страницу с меткой: `index.html?city=saratov`
3. В консоли выполните:
   ```javascript
   localStorage.getItem('selectedCity')
   ```
   Должно вернуть: `"saratov"`

4. Перейдите на страницу без метки: `remont-stiralnoj-mashiny.html`
5. Проверьте номера телефонов - должны быть для Саратова
6. Проверьте ссылки - должны содержать `?city=saratov`

### Очистка сохраненного города:

Если нужно сбросить сохраненный город для тестирования:

```javascript
localStorage.removeItem('selectedCity');
```

Или через консоль браузера:
1. Откройте DevTools (F12)
2. Перейдите на вкладку "Application" (или "Хранилище")
3. Найдите "Local Storage"
4. Найдите ключ `selectedCity` и удалите его

## Итог

Система работает так:
1. **Первый визит с меткой** → город сохраняется
2. **Все последующие страницы** → используют сохраненный город
3. **Смена города** → обновляет сохраненный город
4. **Работает автоматически** → без дополнительных действий

Это обеспечивает непрерывность опыта пользователя - если он пришел из рекламы для Саратова, все страницы будут показывать номера для Саратова, даже если он перейдет на страницу без метки города.

